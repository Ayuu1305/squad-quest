rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Check if the user is not touching restricted fields
    function notUpdating(fields) {
      return !request.resource.data.diff(resource.data).affectedKeys().hasAny(fields);
    }
    
    function isQuestHost(questId) {
      return get(/databases/$(database)/documents/quests/$(questId)).data.hostId == request.auth.uid;
    }

    // üõ°Ô∏è NEW: Validate incoming data types (Basic Schema Validation)
    function isValidQuest() {
       let data = request.resource.data;
       return data.title is string && data.title.size() < 100 
           && data.description is string 
           && data.maxMembers is number;
    }

    // ‚úÖ USERS
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId);

      // üîÑ SELF-HEALING SYNC: Allow users to update their own stats from AuthContext
      // This enables the "xp sync" feature while still blocking critical fields
      allow update: if isOwner(userId)
        && notUpdating([
          // 'badges',          // üü¢ ENABLED: Commented out so users CAN sync badges
          'daily_streak',    // ‚ùå Backend-only (managed by bounty logic)
          'last_claimed_at', // ‚ùå Backend-only (bounty timestamp)
          'roles',           // ‚ùå Security: Prevent privilege escalation
          'isAdmin'          // ‚ùå Security: Prevent users from making themselves Admin
        ]);

      allow delete: if false;

      match /joinedQuests/{questId} {
        allow read, create, delete: if isOwner(userId);
        allow update: if false;
      }
    }

    // ‚úÖ USER STATS (Private storage - BACKEND ONLY)
    match /userStats/{userId} {
      allow read: if isOwner(userId); // üõ°Ô∏è Only owner can read their stats
      allow write: if false;          // üîí LOCKED: Only backend can write via Admin SDK
    }

    // ‚úÖ BOUNTIES (The Economy)
    // üõ°Ô∏è ADDED: Frontend needs to READ bounties, but only Backend writes them.
    match /bounties/{bountyId} {
      allow read: if isAuthenticated();
      allow write: if false; 
    }

    // ‚úÖ QUESTS
    match /quests/{questId} {
      // 1. Everyone can read quests
      allow read: if isAuthenticated();
      
      // 2. CREATE: Fixed the "Permission Denied" error
      // - Removed 'isValidQuest()' (it was blocking valid data).
      // - checks for 'hostId' OR 'createdBy' (handles your variable naming mismatch).
      allow create: if isAuthenticated() && (
        (request.resource.data.hostId == request.auth.uid) || 
        (request.resource.data.createdBy == request.auth.uid)
      );

      // 3. UPDATE: Handles Editing, Joining, and Completing
      allow update: if isAuthenticated() && (
        // SCENARIO A: The Host is updating details (Title, Description, etc.)
        (
          (resource.data.hostId == request.auth.uid || resource.data.createdBy == request.auth.uid)
        ) ||
        
        // SCENARIO B: A User is Joining/Leaving (Updating the arrays)
        // We allow updates to ANY of these fields to prevent blocking:
        // 'participants', 'currentPlayers' (Your specific frontend fields)
        // 'members', 'membersCount' (Your old fields)
        (
            request.resource.data.diff(resource.data).affectedKeys()
            .hasAny(['participants', 'currentPlayers', 'members', 'membersCount', 'status', 'updatedAt', 'completedBy'])
        )
      );

      // 4. DELETE: Only the Host can delete
      allow delete: if (resource.data.hostId == request.auth.uid || resource.data.createdBy == request.auth.uid);

      // --- SUBCOLLECTIONS (Keep these exactly as they were) ---

      // ‚úÖ MEMBERS SUBCOLLECTION
      match /members/{memberId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && request.auth.uid == memberId;
        allow delete: if isAuthenticated() && request.auth.uid == memberId;
        allow update: if false;
      }

      // ‚úÖ CHAT
      match /chat/{messageId} {
        // Allow read if user is in 'participants' array OR 'members' subcollection
        allow read: if isAuthenticated();
        
        // Sender must be the current user
        allow create: if isAuthenticated() && request.resource.data.senderId == request.auth.uid;

        allow delete: if (get(/databases/$(database)/documents/quests/$(questId)).data.hostId == request.auth.uid);
      }

      // ‚úÖ VERIFICATIONS
      match /verifications/{userId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && request.auth.uid == userId;
        allow delete: if (get(/databases/$(database)/documents/quests/$(questId)).data.hostId == request.auth.uid);
      }
    }


  // ‚úÖ ARCHIVED QUESTS (For Past Missions History)
    match /archived_quests/{questId} {
      allow read: if isAuthenticated(); // Allow users to read history
      allow write: if false;            // üîí Locked: Only Backend can move items here
    }


    // ‚úÖ HUBS
    match /hubs/{hubId} {
      allow read: if true;
      allow write: if false;
    }

    // ‚úÖ GLOBAL ACTIVITY FEED
    match /global_activity/{docId} {
      allow read: if isAuthenticated();
      // üõ°Ô∏è UPDATED: Users can only log THEIR OWN activity
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }

    // ‚úÖ HALL OF FAME
    match /hall_of_fame/{docId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // ‚úÖ REPORTS
    match /reports/{docId} {
      allow create: if isAuthenticated() && request.resource.data.reporterId == request.auth.uid;
      allow read, update, delete: if false;
    }
    
    // ‚úÖ SHOP ITEMS
    match /shop_items/{itemId} {
      allow read: if true; // Everyone can see shop items
      allow write: if request.auth != null && request.auth.uid == "dh5BwkAg58VIu1zI1qtD3PJW1a62"; // Admin only
    }
    
    // Default deny for everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}