rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function notUpdating(fields) {
      return !request.resource.data.diff(resource.data).affectedKeys().hasAny(fields);
    }

    // ✅ USERS
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId);

      allow update: if isOwner(userId)
        && notUpdating([
          'xp', 'level', 'thisWeekXP', 'reliabilityScore', 
          'badges', 'daily_streak', 'last_claimed_at'
        ]);

      allow delete: if false;

      match /joinedQuests/{questId} {
        allow read, create, delete: if isOwner(userId);
        allow update: if false;
      }
    }

    // ✅ USER STATS (Backup/Private storage)
    match /userStats/{userId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // ✅ QUESTS
    match /quests/{questId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();

      allow update: if isAuthenticated() && (
        resource.data.hostId == request.auth.uid ||
        (
          exists(/databases/$(database)/documents/quests/$(questId)/members/$(request.auth.uid)) &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(["status", "completedBy", "updatedAt"])
        )
      );

      // ✅ MEMBERS
      match /members/{memberId} {
        allow read: if isAuthenticated();

        allow create: if isAuthenticated()
          && request.auth.uid == memberId
          && request.resource.data.uid == request.auth.uid;

        allow update, delete: if false;
      }

      // ✅ CHAT
      match /chat/{messageId} {
        allow read: if isAuthenticated()
          && exists(/databases/$(database)/documents/quests/$(questId)/members/$(request.auth.uid));

        allow create: if isAuthenticated()
          && exists(/databases/$(database)/documents/quests/$(questId)/members/$(request.auth.uid));

        allow update, delete: if false;
      }

      // ✅ VERIFICATIONS
      match /verifications/{userId} {
        allow read: if isAuthenticated()
          && exists(/databases/$(database)/documents/quests/$(questId)/members/$(request.auth.uid));

        allow create: if isAuthenticated()
          && request.auth.uid == userId
          && exists(/databases/$(database)/documents/quests/$(questId)/members/$(request.auth.uid))
          && !exists(/databases/$(database)/documents/quests/$(questId)/verifications/$(userId));

        allow update, delete: if false;
      }
    }

    // ✅ HUBS
    match /hubs/{hubId} {
      allow read: if true;
      allow write: if false;
    }

    // ✅ GLOBAL ACTIVITY FEED
    match /global_activity/{docId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only backend writes here now
    }

    // ✅ HALL OF FAME
    match /hall_of_fame/{docId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // ✅ REPORTS
    match /reports/{docId} {
      allow create: if isAuthenticated();
      allow read: if false;
      allow update, delete: if false;
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
