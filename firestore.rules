rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function notUpdating(fields) {
      return !request.resource.data.diff(resource.data).affectedKeys().hasAny(fields);
    }
    
    function isQuestHost(questId) {
      return get(/databases/$(database)/documents/quests/$(questId)).data.hostId == request.auth.uid;
    }

    // ✅ USERS
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId);

      allow update: if isOwner(userId)
        && notUpdating([
          'xp', 'level', 'thisWeekXP', 'reliabilityScore', 
          'badges', 'daily_streak', 'last_claimed_at'
        ]);

      allow delete: if false;

      match /joinedQuests/{questId} {
        allow read, create, delete: if isOwner(userId);
        allow update: if false;
      }
    }

    // ✅ USER STATS (Backup/Private storage)
    match /userStats/{userId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // ✅ QUESTS
    match /quests/{questId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();

      // ✅ UPDATE: Host can edit quest details + Members can update status/completedBy + Members/count can be updated for join/leave
      allow update: if isAuthenticated() && (
        // Host can update quest details (excluding protected fields)
        (resource.data.hostId == request.auth.uid && 
         notUpdating(['members', 'membersCount', 'completedBy', 'createdAt', 'hostId'])) ||
        
        // Members can mark quest as completed
        (exists(/databases/$(database)/documents/quests/$(questId)/members/$(request.auth.uid)) &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(["status", "completedBy", "updatedAt"])) ||
        
        // ✅ NEW: Allow members/membersCount updates for join/leave operations
        (isAuthenticated() && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(["members", "membersCount", "updatedAt"]))
      );
      
      // ✅ DELETE: Only host can delete quest
      allow delete: if resource.data.hostId == request.auth.uid;

      // ✅ MEMBERS
      match /members/{memberId} {
        allow read: if isAuthenticated();

        allow create: if isAuthenticated()
          && request.auth.uid == memberId
          && request.resource.data.uid == request.auth.uid;

        // ✅ NEW: Member can delete their own membership
        allow delete: if isAuthenticated() && request.auth.uid == memberId;
        
        allow update: if false;
      }

      // ✅ CHAT
      match /chat/{messageId} {
        allow read: if isAuthenticated()
          && exists(/databases/$(database)/documents/quests/$(questId)/members/$(request.auth.uid));

        allow create: if isAuthenticated()
          && exists(/databases/$(database)/documents/quests/$(questId)/members/$(request.auth.uid));

        // ✅ NEW: Host can delete chat messages
        allow delete: if isQuestHost(questId);
        
        allow update: if false;
      }

      // ✅ VERIFICATIONS
      match /verifications/{userId} {
        allow read: if isAuthenticated()
          && exists(/databases/$(database)/documents/quests/$(questId)/members/$(request.auth.uid));

        allow create: if isAuthenticated()
          && request.auth.uid == userId
          && exists(/databases/$(database)/documents/quests/$(questId)/members/$(request.auth.uid))
          && !exists(/databases/$(database)/documents/quests/$(questId)/verifications/$(userId));

        // ✅ NEW: Host can delete verifications when deleting quest
        allow delete: if isQuestHost(questId);
        
        allow update: if false;
      }
    }

    // ✅ HUBS
    match /hubs/{hubId} {
      allow read: if true;
      allow write: if false;
    }

    // ✅ GLOBAL ACTIVITY FEED
    match /global_activity/{docId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only backend writes here now
    }

    // ✅ HALL OF FAME
    match /hall_of_fame/{docId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // ✅ REPORTS
    match /reports/{docId} {
      allow create: if isAuthenticated();
      allow read: if false;
      allow update, delete: if false;
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
